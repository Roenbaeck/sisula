-- creates utility functions needed in the staging
-- using Microsoft.SQLServer.Types version 11 (2012+)
IF Object_Id('dbo.Splitter', 'FT') IS NOT NULL
DROP FUNCTION [dbo].[Splitter];
GO

IF Object_Id('dbo.IsType', 'FS') IS NOT NULL
DROP FUNCTION [dbo].[IsType];
GO


IF EXISTS (
	SELECT
		*
	FROM
		sys.assemblies
	WHERE
		name = 'Utilities'
)
DROP ASSEMBLY Utilities;

CREATE ASSEMBLY Utilities
AUTHORIZATION dbo
-- you can use the DLL instead if you substitute for your path:
--FROM 'C:\sisula\code\Utilities.dll'
-- or you can use the binary representation of the compiled code:
FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C01030063155B550000000000000000E00002210B010800001800000006000000000000AE360000002000000040000000004000002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000543600005700000000400000A802000000000000000000000000000000000000006000000C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000B4160000002000000018000000020000000000000000000000000000200000602E72737263000000A80200000040000000040000001A0000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001E00000000000000000000000000004000004200000000000000000000000000000000903600000000000048000000020005001C2600003810000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009A0F00FE16030000016F0600000A0F01FE16030000016F0600000A16280700000A6F0800000A2A0013300300370000000100001102740F0000010A066F0900000A7E0A00000A280B00000A2C0C037E0C00000A81030000012A03066F0900000A730D00000A81030000012A1E02280E00000A2A001B30040073040000020000110F00FE16030000016F0600000A6F0F00000A0A0F01FE16030000016F0600000A6F0F00000A0B7E04000004076F1000000A6F0800000A0C0872010000706F1100000A6F0900000A0D08720B0000706F1100000A6F0900000A130408721F0000706F1100000A6F0900000A1305096F1200000A25130A39E3030000FE137E050000043AB20100001F21731400000A25722B00007016281500000A25723300007017281500000A25724300007018281500000A25725500007019281500000A25725D0000701A281500000A25726B0000701B281500000A2572810000701C281500000A25728D0000701D281500000A25729D0000701E281500000A2572AD0000701F09281500000A2572B70000701F0A281500000A2572C30000701F0B281500000A2572CD0000701F0C281500000A2572DF0000701F0D281500000A2572F30000701F0E281500000A2572FD0000701F0F281500000A25720D0100701F10281500000A2572190100701F11281500000A25722B0100701F12281500000A25724D0100701F13281500000A25725F0100701F14281500000A2572730100701F15281500000A25727B0100701F16281500000A2572850100701F17281500000A2572A30100701F18281500000A2572BB0100701F19281500000A2572C70100701F1A281500000A2572D10100701F1B281500000A2572DD0100701F1C281500000A2572F30100701F1D281500000A25720B0200701F1E281500000A2572170200701F1F281500000A25722B0200701F20281500000AFE138005000004FE137E05000004110A120B281600000A3910020000110B452100000005000000110000001D0000002900000035000000410000008D000000A8000000A8000000C9000000010100003601000036010000360100003F0100003F0100003F0100003F010000620100006B01000079010000850100008501000085010000850100008501000085010000850100008501000085010000850100008501000085010000388001000006281700000A26387401000006281800000A26386801000006281900000A26385C01000006281A00000A26385001000006281B00000A2638440100000628050000061A3106731C00000A7A06281D00000A130611067E01000004281E00000A25281F00000A2D1111067E02000004282000000A282100000A281F00000A39FE000000731C00000A7A0628050000061A3106731C00000A7A06281D00000A2638DD0000000628050000061105282200000A3106731C00000A7A06282300000A2638BC00000006282400000A13071207FE161B0000016F0600000A6F2500000A066F2500000A0628060000062C03162B0117583B8A000000731C00000A7A06282600000A13081208FE161C0000016F0600000A6F2500000A066F2500000A0628060000062C03162B0117582E55731C00000A7A06282700000A262B461104723F020070282800000A2C38066F2500000A1104282200000A3129731C00000A7A06282900000A262B1A06282A00000A282B00000A262B0C06282A00000A282C00000A267E2D00000A1309DE0A267E2E00000A1309DE0011092A00411C0000000000006C000000FA030000660400000A000000010000011330020022000000030000117E03000004026F1000000A6F0800000A0A06721F0000706F1100000A6F2F00000A2A00001330020022000000030000117E03000004026F1000000A6F0800000A0A0672470200706F1100000A6F2F00000A2A0000033003004700000000000000232D431CEBE2360AC1733000000A80010000042367D5E7EAE2360A41733000000A800200000472530200701E733100000A800300000472AD0200701E733100000A80040000042A1E02280E00000A2A0042534A4201000100000000000C00000076322E302E35303732370000000005006C000000D0030000237E00003C0400009404000023537472696E677300000000D00800003403000023555300040C0000100000002347554944000000140C00002404000023426C6F620000000000000002000001571502080900000000FA01330016000001000000200000000400000005000000080000000800000031000000080000000300000001000000010000000400000000000A00010000000000060038003100060052003F000A007F006A000A00A2006A000A00CD006A000E001B01FC000A0055013A010600A40185010600F401D40106001402D4010A003C023A010E005A02FC000E006002FC000E006D02FC000E008802FC000E008E02FC000600A002310006001903D40106004F0334030A0086036A000A008E036A000A0097036A000A00A0036A000600A90331000600E50331000A00F5036A000A0000046A000A0015046A000A001F046A000A0039046A00120067044D04120073044D0400000000010000000000010001000100100018000000050001000100010010002100000005000100040000000000D40200000500050009003100D6002D003100E9002D0031002101310031002C01310013005C033303502000000000960089000A0001007820000000009600940013000300BB200000000086189C001B000500C42000000000960089001F0005006025000000009100AD00280007009025000000009100BE002800080013260000000086189C001B000900C0250000000091188B04EC030900000001003601000002006701000001006F01020002007F0100000100B10100000200BE0100000100CA0100000100CA0139009C001B0041009C001B0049009C00480051009C001B0059009C001B0009005102B10131005A02B50161007D02BE0181009602B1018900A702C3018900AD02C6011900B902CC0119009C00D00109009C001B008900BE02B10131005A0222037100C30228038900CC02B10191009C001B000C009C0048000C00700342030C0074034A03210080035303A10080035903A90080035F03B10080036503B90080036B03C1009C001B002900800371032900BB0377032100C40380032900CC0377032100D8038603C900ED032800D10080038F03D9008003950389000A049B03E10080039F03E9008003A50389002B04C601F1008003AB0319004104B103F9008003C00301018003C70321008004CF0321008504CF0381000A049B0329009C00F00331009C00F50320002B004D0024000B0035002E00230005042E001B00FC0380002B00DA0183009B002E0384000B003500A4000B003500D501D303E7033B0304800000000000000000000000000000000032020000020000000000000000000000010028000000000002000000000000000000000001005E000000000002000000000000000000000001003100000000000B0000000000000000000000B7034D040000000000000000003C4D6F64756C653E005574696C69746965732E646C6C0053706C697474657200497354797065006D73636F726C69620053797374656D004F626A6563740053797374656D2E436F6C6C656374696F6E730049456E756D657261626C650053797374656D2E446174610053797374656D2E446174612E53716C54797065730053716C537472696E6700496E69744D6574686F640046696C6C526F77002E63746F720053716C426F6F6C65616E004E756D6265724F66446563696D616C73004E756D6265724F6657686F6C65730053716C4D6F6E657900736D616C6C6D6F6E65794D696E56616C756500736D616C6C6D6F6E65794D617856616C75650053797374656D2E546578742E526567756C617245787072657373696F6E730052656765780073706C697456616C75650073706C69745479706500726F77004D6963726F736F66742E53716C5365727665722E5365727665720053716C4661636574417474726962757465007061747465726E0066726F6D456E756D65726174696F6E006D617463680053797374656D2E52756E74696D652E496E7465726F705365727669636573004F75744174747269627574650073716C4461746156616C75650073716C4461746154797065006461746156616C75650053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465005574696C69746965730053716C46756E6374696F6E41747472696275746500546F537472696E67004D617463680052656765784F7074696F6E730047726F7570436F6C6C656374696F6E006765745F47726F7570730047726F75700043617074757265006765745F56616C756500537472696E6700456D707479006F705F457175616C697479004E756C6C005472696D006765745F4974656D00546F4C6F776572003C50726976617465496D706C656D656E746174696F6E44657461696C733E7B41423436464546442D354639372D343235412D414542392D4434393732333432354146327D00436F6D70696C657247656E6572617465644174747269627574650053797374656D2E436F6C6C656374696F6E732E47656E657269630044696374696F6E61727960320024246D6574686F643078363030303030342D31004164640054727947657456616C75650050617273650053716C427974650053716C496E7431360053716C496E7433320053716C496E743634004F766572666C6F77457863657074696F6E004C6573735468616E006F705F5472756500477265617465725468616E006F705F426974776973654F7200436F6E7665727400546F496E7433320053716C446563696D616C0053716C53696E676C65006765745F4C656E6774680053716C446F75626C650053716C4461746554696D65006F705F496E657175616C6974790053716C47756964006F705F496D706C69636974004D6963726F736F66742E53716C5365727665722E54797065730053716C47656F6D657472790053716C47656F67726170687900547275650046616C7365002E6363746F7200000000097400790070006500001370007200650063006900730069006F006E00000B7300630061006C0065000007620069007400000F740069006E00790069006E007400001173006D0061006C006C0069006E007400000769006E007400000D62006900670069006E007400001573006D0061006C006C006D006F006E0065007900000B6D006F006E0065007900000F64006500630069006D0061006C00000F6E0075006D00650072006900630000097200650061006C00000B66006C006F00610074000009640061007400650000116400610074006500740069006D00650000136400610074006500740069006D006500320000096300680061007200000F7600610072006300680061007200000B6E00630068006100720000116E007600610072006300680061007200002175006E0069007100750065006900640065006E007400690066006900650072000011670065006F006D0065007400720079000013670065006F00670072006100700068007900000778006D006C000009740069006D006500001D6400610074006500740069006D0065006F0066006600730065007400001768006900650072006100720063006800790069006400000B69006D0061006700650000097400650078007400000B6E007400650078007400001572006F007700760065007200730069006F006E000017730071006C005F00760061007200690061006E007400000B7400610062006C0065000013740069006D0065007300740061006D0070000013760061007200620069006E0061007200790000076D0061007800000B770068006F006C006500005928003F003C00770068006F006C0065003E005B0030002D0039005D002B0029003F0028003F003A005B005E0030002D0039005D0028003F003C007300630061006C0065003E005B0030002D0039005D002B00290029003F0001808328003F003C0074007900700065003E005B005E00280029005D002B00290028003F003A005C0073002A005C00280028003F003C0070007200650063006900730069006F006E003E005B005E002C00280029005D002A0029002C003F0028003F003C007300630061006C0065003E005B005E0029005D002A0029005C00290029003F00000000FDFE46AB975F5A42AEB9D49723425AF20008B77A5C561934E0890800021209110D110D070002011C10110D032000010800021111110D110D040001080E030611150306121912010001005408074D617853697A65FFFFFFFF042001010881620100050054557F4D6963726F736F66742E53716C5365727665722E5365727665722E53797374656D446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038391053797374656D44617461416363657373000000005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E1146696C6C526F774D6574686F644E616D650746696C6C526F770320000E08000312310E0E1135042000123902060E050002020E0E0306110D042001010E040701123D81460100040054557F4D6963726F736F66742E53716C5365727665722E5365727665722E53797374656D446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038391053797374656D44617461416363657373000000005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E6973746963015402094973507265636973650105200112310E052001123D0E0401000000070615124D020E080615124D020E08072002011300130108200202130010130105000111110E05000111510E05000111550E05000111590E050001115D0E05000111150E08000211111115111505000102111108000211111111111105000111690E050001116D0E0320000805000111710E05000111750E05000111790E050001110D0E0889845DCD8080CC91060001127D110D070001128081110D0306111113070C0E0E12390E0E0E1115116D117111110E08040701123903000001042001010D062002010E11350801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773017C36000000000000000000009E360000002000000000000000000000000000000000000000000000903600000000000000000000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF25002040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000004C02000000000000000000004C0234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004AC010000010053007400720069006E006700460069006C00650049006E0066006F0000008801000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E00300000003C000E00010049006E007400650072006E0061006C004E0061006D00650000005500740069006C00690074006900650073002E0064006C006C0000002800020001004C006500670061006C0043006F00700079007200690067006800740000002000000044000E0001004F0072006900670069006E0061006C00460069006C0065006E0061006D00650000005500740069006C00690074006900650073002E0064006C006C000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000C000000B03600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
WITH PERMISSION_SET = SAFE;
GO

CREATE FUNCTION Splitter(@row AS nvarchar(max), @pattern AS nvarchar(4000))
RETURNS TABLE (
	[match] nvarchar(max)
) AS EXTERNAL NAME Utilities.Splitter.InitMethod;
GO

CREATE FUNCTION IsType(@dataValue AS nvarchar(max), @dataType AS nvarchar(4000))
RETURNS BIT
AS EXTERNAL NAME Utilities.IsType.InitMethod;
GO

sp_configure 'clr enabled', 1
GO
reconfigure with override
GO

/*
with strgen as (
	select
		'Hello World' as s,
		1 as n
	union all
	select
		s,
		n + 1
	from
		strgen
	where
		n < 100000
)
select
	*
from
	strgen
cross apply (
	select
		[match],
		ROW_NUMBER() OVER (ORDER BY (SELECT 1)) as i
	from
		dbo.Splitter(N'Hello World', N'(.{2}).*(Wo)(rl).*')
) s
pivot (
	max(match) for i in ([2], [3], [4], [5])
) p
option (maxrecursion 0);
*/
